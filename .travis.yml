# @file
# Campaign profile travis-ci script
sudo: required

services:
- docker

git:
  depth: 1

env:
  DOCKER_COMPOSE_VERSION: 1.15.0
  global:
    - DOCKER_CACHE_DIR=$HOME/.cache/docker
    - CACHE_FILE_PHP=$DOCKER_CACHE_DIR/php.tar.gz
    - CACHE_FILE_SOLR=$DOCKER_CACHE_DIR/solr.tar.gz
    - CACHE_FILE_MYSQL=$DOCKER_CACHE_DIR/mysql.tar.gz
    - CACHE_FILE_RABBITMQ=$DOCKER_CACHE_DIR/rabbitmq.tar.gz
    - CACHE_FILE_SELENIUM=$DOCKER_CACHE_DIR/selenium.tar.gz

before_install:
# Update docker-composer to usable version
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- if [ -f ${CACHE_FILE_PHP} ]; then gunzip -c ${CACHE_FILE_PHP} | docker load; fi
- if [ -f ${CACHE_FILE_SOLR} ]; then gunzip -c ${CACHE_FILE_SOLR} | docker load; fi
- if [ -f ${CACHE_FILE_MYSQL} ]; then gunzip -c ${CACHE_FILE_MYSQL} | docker load; fi
- if [ -f ${CACHE_FILE_RABBITMQ} ]; then gunzip -c ${CACHE_FILE_RABBITMQ} | docker load; fi
- if [ -f ${CACHE_FILE_SELENIUM} ]; then gunzip -c ${CACHE_FILE_SELENIUM} | docker load; fi

install:
- docker-compose up -d
- mkdir -p $DOCKER_CACHE_DIR
- if [ ! -f ${CACHE_FILE_PHP} ]; then docker save comicrelief/php-drupal:latest | gzip > ${CACHE_FILE_PHP}; fi
- if [ ! -f ${CACHE_FILE_SOLR} ]; then docker save solr:6.3-alpine | gzip > ${CACHE_FILE_SOLR}; fi
- if [ ! -f ${CACHE_FILE_MYSQL} ]; then docker save mysql:5 | gzip > ${CACHE_FILE_MYSQL}; fi
- if [ ! -f ${CACHE_FILE_RABBITMQ} ]; then docker save rabbitmq:3-management | gzip > ${CACHE_FILE_RABBITMQ}; fi
- if [ ! -f ${CACHE_FILE_SELENIUM} ]; then docker save selenium/standalone-chrome-debug:latest | gzip > ${CACHE_FILE_SELENIUM}; fi

before_script:
- docker-compose exec web composer campaign:build || true
- docker-compose exec web chmod ugo+rw web/sites/default -R

script:
- docker-compose exec web ci/travis/run-tests.sh
- docker-compose exec web ci/travis/dberrors.sh

cache:
  directories:
    - vendor
    - themes/custom/campaign_base/node_modules
    - $DOCKER_CACHE_DIR

notifications:
  slack:
    rooms:
    - secure: "XKfVLQ6h7CxqpB6CX5OWz61MI4lyNS26+I4CeuatVAME5n8wJVEvuC/hTHAMQ9YCyohi8v+LVuHdCTNNzPAkxA+AD2HyPH4sOIjgxtLseo6UDW/eW2XGMDesIAYIVyYKlwnzePiJ10PG792RpU3a6Q/smoerVoIyWzIalNwpRbzG9WgFowoJkOYkPXBQ4X2i7yhWvw3cjrVR6fd+26du/+nqg0NmbrbiOd7RmWnx/kKvW7TuJWVAEuChk7yCGXCGZxwJYEFBOJO/fhgD4vD/+JcXmA+i7OYR42zyc0oDMt60t2zp9Qwk5P2Ymn5tCXdr4r+XE7QK/bckTSaLIn6T02KGQgmlZK+HJLmN3Mbq1EBjmZnlyUuR9klfdllPmPFI/NqABxUez2nT1RhCcKXHMLG7ilUqEuPt/FXtzxuiCwQS0RlanhAJMOabQxxGLR430Gd91lARkCffB0VMEQnsSvUzLINvp+XU0vjnClqO1am9vfKuLMFsNDrqEuA/EQUtiBCR7RJbEfNa21vX1blSFQk2x7pKHwhnItRvcbpBksKnZhvXtOQBnG6W2tc8Li91XN6++5eD3vW/K0nJsIJTXvqaZBET7ZEj8QKSeBG248ZYo/yHiouhr6GIbMLncmhPuUV6gIqff3xqGBqnZexTM2AuhOKX90oT3wxiDn79A58="
