# @file
# Campaign profile travis-ci script

language: php
php:
  - 5.6

git:
  depth: 1
sudo: false
cache:
  apt: true
  bundler: true
  directories:
    - $HOME/tmp/drush
    - $HOME/.bundle
    - $HOME/.composer
    - node_modules
    - vendor
rvm:
  - 2.1.5

matrix:
  fast_finish: true

env:
  global:
    # add composer's global bin directory to the path
    # see: https://github.com/drush-ops/drush#install---composer
    - PATH="$PATH:$HOME/.composer/vendor/bin"

    # Configuration variables.
    - export PROFILE="cr"
    - export DB="drupal"
    - export DB_URL="mysql://root:@127.0.0.1/drupal"
    - export BEHAT_DIR="./profiles/$PROFILE/tests/behat"
    - export BEHAT_DRIVER="phantomjs"
    - export BEHAT_BROWSER="firefox"
    # Note: Do not add a trailing slash here.
    - export WEBSERVER_URL="http://127.0.0.1"
    - export WEBSERVER_PORT="8080"
    - export TRAVIS_COMMIT_MSG=\"$(git log --format=%B --no-merges -n 1)\"

mysql:
  database: $DB
  username: root
  encoding: utf8

before_install:
  - rvm install 2.1.5
  - composer global config minimum-stability beta
  - composer global require phing/phing drush/drush:8.*
  # Prepare environment
  - ./profiles/cr/tests/scripts/before-install.sh
  # Check code quality before site is installed
  - ./profiles/cr/tests/scripts/code-checks.sh

install:
  - ./profiles/cr/tests/scripts/install.sh

before_script:
  - ./profiles/cr/tests/scripts/before-tests.sh

script:
  # Behat
  - ./profiles/cr/tests/scripts/run-tests.sh
  # Check DB errors
  - ./profiles/cr/tests/scripts/dberrors.sh

after_success:
  # Deploy to platform.sh (only for the develop branch)
  - ./profiles/cr/tests/scripts/build.sh

notifications:
  slack: comicrelief:W1jExvqbSU9Kb3lyavdGHdGD
  # email: false
